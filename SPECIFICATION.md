# ダイスツール 共通仕様書

## プロジェクト概要

ダイスツールCLI。
シンプルで軽量なダイスロール機能と、統計解析機能を提供する。

---

## 基本仕様

### 1. ダイスロール機能

#### コマンド形式
```
dice_tool <ダイス個数>d<ダイス面数>
```

#### 例
```
dice_tool 2d6      # 6面ダイスを2個振る
dice_tool 1d20     # 20面ダイスを1個振る
dice_tool 3d10     # 10面ダイスを3個振る
dice_tool 1d100    # 100面ダイス（パーセンタイルダイス）を1個振る
```

#### 動作
1. 指定されたダイス個数とダイス面数に基づいてダイスロールを実行
2. 各ダイスの結果を表示
3. 合計値を表示
4. 結果をログファイルに記録

#### 出力形式
```
Rolling 2d6...
Results: [4, 3]
Total: 7
```

#### 制約
- ダイス個数: 1以上の整数（推奨上限: 1000）
- ダイス面数: 2以上の整数（推奨上限: 10000）
- 入力形式は厳密に `<数値>d<数値>` に従う（小文字のd）

---

### 2. ログ機能

#### ログファイル
- ファイル名: `dice_log.txt`
- 実行ファイルと同じディレクトリに保存
- UTF-8エンコーディング

#### ログフォーマット
```
[YYYY-MM-DD HH:MM:SS] XdY: [結果の配列] = 合計値
```

#### ログ例
```
[2025-10-25 14:23:15] 2d6: [4, 3] = 7
[2025-10-25 14:24:01] 1d20: [15] = 15
[2025-10-25 14:25:30] 3d10: [7, 2, 9] = 18
```

#### ログ管理ルール
1. 新しいロールの結果は常にファイルの末尾に追記
2. ログ行数が100行を超えた場合、古い行から削除して100行を維持
3. ログファイルが存在しない場合は自動的に作成

#### ログ参照コマンド
```
dice_tool --history
# または
dice_tool -l
```

---

### 3. 統計解析機能（重たい処理）

#### コマンド形式
```
dice_tool --stats <ダイス面数>
# または
dice_tool -s <ダイス面数>
```

#### 例
```
dice_tool --stats 6     # 6面ダイスの統計
dice_tool -s 20         # 20面ダイスの統計
```

#### 動作
1. 指定されたダイス面数で**10,000回**ダイスロールを実行（ハードコーディング）
2. 以下の統計値を計算して表示：
   - **平均値** (Mean): すべての結果の算術平均
   - **中央値** (Median): 結果を昇順に並べた際の中央の値
   - **最頻値** (Mode): 最も頻繁に出た値（複数ある場合は全て表示）
3. 統計結果はログファイルに**記録しない**

#### 出力形式
```
Rolling 1d6 10,000 times...
Results:
  Mean: 3.51
  Median: 4
  Mode: 3
```

#### 複数の最頻値がある場合
```
Rolling 1d6 10,000 times...
Results:
  Mean: 3.49
  Median: 3
  Mode: 2, 5  # 2と5が同じ頻度で出現した場合
```

#### 制約
- ロール回数は10,000回で固定（ハードコーディング）
- ダイス個数は常に1個
- ダイス面数: 2以上の整数（推奨上限: 10000）

---

### 4. ヘルプ表示

#### コマンド形式
```
dice_tool --help
# または
dice_tool -h
# または引数なし
dice_tool
```

#### 出力内容
```
Dice Tool - A simple CLI dice roller

Usage:
  dice_tool <N>d<M>        Roll N dice with M sides
  dice_tool --history      Show roll history (last 100 rolls)
  dice_tool --stats <M>    Roll 1d<M> 10,000 times and show statistics
  dice_tool --help         Show this help message

Examples:
  dice_tool 2d6            Roll two 6-sided dice
  dice_tool 1d20           Roll one 20-sided dice
  dice_tool --stats 6      Get statistics for 10,000 rolls of 1d6

Options:
  -l, --history            Show roll history
  -s, --stats <M>          Show statistics
  -h, --help               Show help
```

---

## エラーハンドリング

### 1. 不正な入力形式
**入力**: `dice_tool 2x6` または `dice_tool abc`

**出力**:
```
Error: Invalid format. Use <N>d<M> format (e.g., 2d6)
```

### 2. 範囲外の値
**入力**: `dice_tool 0d6` または `dice_tool 2d1`

**出力**:
```
Error: Dice count and sides must be positive integers greater than 0
```

### 3. ログファイルアクセスエラー
ログファイルの読み書きに失敗した場合:
```
Warning: Failed to write/read log file
```
※ プログラムは継続実行し、ダイスロール結果は表示する

### 4. 引数不足（statsコマンド）
**入力**: `dice_tool --stats`

**出力**:
```
Error: --stats requires a dice side value (e.g., --stats 6)
```

---

## 技術的詳細

### 乱数生成
- 各言語の標準的な疑似乱数生成器を使用
- 必要に応じてシード値を現在時刻で初期化
- 一様分布を保証

### ファイルI/O
- ログファイルの読み書きは排他制御を考慮（可能であれば）
- ファイルが存在しない場合は自動作成
- エンコーディングはUTF-8

### 統計計算
- **平均値**: 小数点第2位まで表示
- **中央値**: データ数が偶数の場合、中央2つの平均値
- **最頻値**: 同じ頻度の値が複数ある場合、昇順で列挙

### パフォーマンス目標
- 通常のダイスロール（100個以下）: 1秒以内
- 統計機能（10,000回ロール）: 5秒以内（目安）

---

## 実装の自由度

以下の点については各言語の特性に応じて実装方法を選択可能：

1. **コマンドライン引数のパース方法**
   - 標準ライブラリまたはサードパーティライブラリの使用可
   - Python: `argparse`, `click`など
   - Go: `flag`, `cobra`など
   - C++: 手動パース、`CLI11`、`cxxopts`など

2. **プロジェクト構成**
   - 単一ファイルまたは複数ファイル・モジュール分割
   - 各言語の慣習に従う

3. **ビルドシステム**
   - 各言語の標準的なビルドツールを使用
   - Python: そのまま実行可能
   - Go: `go build`
   - C++: `g++`, `CMake`, `Makefile`など

---

## 実装チェックリスト

各言語での実装完了時に以下を確認：

- [ ] `Xd Y`形式でダイスロールができる
- [ ] ロール結果が正しく表示される
- [ ] ログファイルに結果が記録される
- [ ] ログが100行を超えると古いものが削除される
- [ ] `--history`でログが表示できる
- [ ] `--stats M`で統計が計算できる
- [ ] 統計結果（平均、中央値、最頻値）が正しい
- [ ] `--help`でヘルプが表示される
- [ ] 不正な入力に対してエラーメッセージが表示される
- [ ] READMEに使用方法が記載されている

---

## バージョン履歴

- **v1.0** (2025-10-25): 初版作成

